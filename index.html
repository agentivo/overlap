<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overlap - Find a time that works for everyone</title>
  <meta name="description" content="Simple availability scheduling. Click and drag to mark when you're free, share the link, find the overlap.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='10' y='30' width='40' height='40' rx='8' fill='%234caf50' opacity='0.7'/><rect x='50' y='30' width='40' height='40' rx='8' fill='%232196f3' opacity='0.7'/></svg>">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .logo svg {
      width: 32px;
      height: 32px;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1d1d1f;
    }

    .subtitle {
      color: #86868b;
    }

    .panels {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 2rem;
    }

    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      height: fit-content;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .sidebar h2 {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      color: #1d1d1f;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #0071e3;
    }

    .time-range {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .time-range select {
      flex: 1;
      padding: 0.625rem;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 0.875rem;
      background: white;
    }

    .participants {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e5e5e5;
    }

    .participant {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      font-size: 0.875rem;
      color: #1d1d1f;
    }

    .participant-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #34c759;
    }

    .main {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .mode-toggle {
      display: flex;
      background: #f5f5f7;
      border-radius: 8px;
      padding: 3px;
    }

    .mode-toggle button {
      padding: 0.5rem 1rem;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      color: #86868b;
      transition: all 0.2s;
    }

    .mode-toggle button.active {
      background: white;
      color: #1d1d1f;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #86868b;
    }

    .legend-bar {
      width: 100px;
      height: 12px;
      border-radius: 3px;
      background: linear-gradient(to right, #e8f5e9, #1b5e20);
    }

    .grid-container {
      position: relative;
      user-select: none;
    }

    .grid {
      display: grid;
      gap: 1px;
      background: #e5e5e5;
      border-radius: 8px;
      overflow: hidden;
    }

    .grid-cell {
      background: #fafafa;
      min-height: 24px;
      transition: background-color 0.1s;
      cursor: pointer;
    }

    .grid-cell.header {
      background: #f5f5f7;
      font-size: 0.75rem;
      font-weight: 600;
      color: #1d1d1f;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 0.5rem;
      cursor: default;
    }

    .grid-cell.time-label {
      background: #f5f5f7;
      font-size: 0.6875rem;
      color: #86868b;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      padding: 2px 8px 0 0;
      cursor: default;
    }

    .grid-cell.available {
      background: #4caf50;
    }

    .grid-cell.available-1 { background: #c8e6c9; }
    .grid-cell.available-2 { background: #a5d6a7; }
    .grid-cell.available-3 { background: #81c784; }
    .grid-cell.available-4 { background: #66bb6a; }
    .grid-cell.available-5 { background: #4caf50; }
    .grid-cell.available-6 { background: #43a047; }
    .grid-cell.available-7 { background: #388e3c; }
    .grid-cell.available-8 { background: #2e7d32; }
    .grid-cell.available-9 { background: #1b5e20; }

    .grid-cell:not(.header):not(.time-label):hover {
      filter: brightness(0.95);
    }

    .date-header {
      text-align: center;
    }

    .date-header .day-name {
      font-size: 0.6875rem;
      color: #86868b;
      font-weight: 500;
    }

    .date-header .day-num {
      font-size: 1rem;
      font-weight: 600;
    }

    .instructions {
      margin-top: 1rem;
      padding: 1rem;
      background: #f5f5f7;
      border-radius: 8px;
      font-size: 0.8125rem;
      color: #86868b;
    }

    .btn {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #0071e3;
      color: white;
    }

    .btn-primary:hover {
      background: #0077ed;
    }

    .btn-secondary {
      background: #f5f5f7;
      color: #1d1d1f;
      margin-top: 0.5rem;
    }

    .btn-secondary:hover {
      background: #e8e8ed;
    }

    .btn-copy {
      margin-top: 0.5rem;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .btn-copy:hover {
      background: #c8e6c9;
    }

    .btn-copy.copied {
      background: #2e7d32;
      color: white;
    }

    .tooltip {
      position: absolute;
      background: #1d1d1f;
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.15s;
      white-space: nowrap;
    }

    .tooltip.visible {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .panels {
        grid-template-columns: 1fr;
      }

      body {
        padding: 1rem;
      }

      .grid-cell.header {
        padding: 0.5rem 0.25rem;
      }

      .date-header .day-num {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <svg viewBox="0 0 100 100" fill="none">
          <rect x="10" y="30" width="40" height="40" rx="8" fill="#4caf50" opacity="0.7"/>
          <rect x="50" y="30" width="40" height="40" rx="8" fill="#2196f3" opacity="0.7"/>
        </svg>
        <h1>Overlap</h1>
      </div>
      <p class="subtitle">Find a time that works for everyone</p>
    </header>

    <div class="panels">
      <div class="sidebar">
        <h2>Your Info</h2>
        <div class="form-group">
          <label>Your Name</label>
          <input type="text" id="userName" placeholder="Enter your name">
        </div>

        <h2>Time Range</h2>
        <div class="form-group">
          <label>Available hours</label>
          <div class="time-range">
            <select id="startTime"></select>
            <span>to</span>
            <select id="endTime"></select>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveAvailability()">Save Availability</button>
        <button class="btn btn-secondary" onclick="clearMyAvailability()">Clear Selection</button>
        <button class="btn btn-copy" id="copyBtn" onclick="copyLink()">Copy Share Link</button>

        <div class="participants">
          <h2>Participants</h2>
          <div id="participantList">
            <p style="font-size: 0.8125rem; color: #86868b;">No one yet</p>
          </div>
        </div>
      </div>

      <div class="main">
        <div class="grid-header">
          <div class="mode-toggle">
            <button class="active" onclick="setMode('edit')">Edit</button>
            <button onclick="setMode('view')">View Group</button>
          </div>
          <div class="legend">
            <span>None</span>
            <div class="legend-bar"></div>
            <span>All</span>
          </div>
        </div>

        <div class="grid-container">
          <div class="grid" id="grid"></div>
          <div class="tooltip" id="tooltip"></div>
        </div>

        <div class="instructions">
          Click and drag to select time slots. Save your availability, then share the link with others.
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let mode = 'edit';
    let isMouseDown = false;
    let isAdding = true;
    let startHour = 9;
    let endHour = 17;
    let days = [];
    let myAvailability = new Set();
    let allParticipants = {};

    // Generate next 7 days
    function generateDays() {
      const today = new Date();
      days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        days.push(date);
      }
    }

    // Populate time selectors
    function populateTimeSelectors() {
      const startSelect = document.getElementById('startTime');
      const endSelect = document.getElementById('endTime');

      for (let h = 0; h < 24; h++) {
        const label = formatHour(h);
        startSelect.options.add(new Option(label, h));
        endSelect.options.add(new Option(label, h));
      }

      startSelect.value = startHour;
      endSelect.value = endHour;

      startSelect.onchange = () => {
        startHour = parseInt(startSelect.value);
        renderGrid();
      };
      endSelect.onchange = () => {
        endHour = parseInt(endSelect.value);
        renderGrid();
      };
    }

    function formatHour(h) {
      if (h === 0) return '12 AM';
      if (h < 12) return h + ' AM';
      if (h === 12) return '12 PM';
      return (h - 12) + ' PM';
    }

    function formatDayName(date) {
      return date.toLocaleDateString('en-US', { weekday: 'short' });
    }

    function formatDayNum(date) {
      return date.getDate();
    }

    function getCellId(dayIndex, hour, quarter) {
      return `${dayIndex}-${hour}-${quarter}`;
    }

    function renderGrid() {
      const grid = document.getElementById('grid');
      const numSlots = (endHour - startHour) * 4;

      if (numSlots <= 0) return;

      grid.style.gridTemplateColumns = `60px repeat(${days.length}, 1fr)`;
      grid.innerHTML = '';

      // Header row
      const cornerCell = document.createElement('div');
      cornerCell.className = 'grid-cell header';
      grid.appendChild(cornerCell);

      days.forEach(date => {
        const headerCell = document.createElement('div');
        headerCell.className = 'grid-cell header';
        headerCell.innerHTML = `
          <div class="date-header">
            <div class="day-name">${formatDayName(date)}</div>
            <div class="day-num">${formatDayNum(date)}</div>
          </div>
        `;
        grid.appendChild(headerCell);
      });

      // Time slots
      for (let h = startHour; h < endHour; h++) {
        for (let q = 0; q < 4; q++) {
          // Time label (only on hour)
          const timeCell = document.createElement('div');
          timeCell.className = 'grid-cell time-label';
          if (q === 0) {
            timeCell.textContent = formatHour(h);
          }
          grid.appendChild(timeCell);

          // Day cells
          days.forEach((date, dayIndex) => {
            const cell = document.createElement('div');
            const cellId = getCellId(dayIndex, h, q);
            cell.className = 'grid-cell';
            cell.dataset.cellId = cellId;
            cell.dataset.day = dayIndex;
            cell.dataset.hour = h;
            cell.dataset.quarter = q;

            cell.addEventListener('mousedown', onCellMouseDown);
            cell.addEventListener('mouseenter', onCellMouseEnter);
            cell.addEventListener('touchstart', onCellTouchStart, { passive: false });
            cell.addEventListener('touchmove', onCellTouchMove, { passive: false });

            grid.appendChild(cell);
          });
        }
      }

      updateGridDisplay();
    }

    function onCellMouseDown(e) {
      if (mode !== 'edit') return;
      isMouseDown = true;
      const cellId = e.target.dataset.cellId;
      isAdding = !myAvailability.has(cellId);
      toggleCell(cellId);
    }

    function onCellMouseEnter(e) {
      if (!isMouseDown || mode !== 'edit') return;
      toggleCell(e.target.dataset.cellId);
    }

    function onCellTouchStart(e) {
      if (mode !== 'edit') return;
      e.preventDefault();
      isMouseDown = true;
      const touch = e.touches[0];
      const cell = document.elementFromPoint(touch.clientX, touch.clientY);
      if (cell && cell.dataset.cellId) {
        isAdding = !myAvailability.has(cell.dataset.cellId);
        toggleCell(cell.dataset.cellId);
      }
    }

    function onCellTouchMove(e) {
      if (!isMouseDown || mode !== 'edit') return;
      e.preventDefault();
      const touch = e.touches[0];
      const cell = document.elementFromPoint(touch.clientX, touch.clientY);
      if (cell && cell.dataset.cellId) {
        toggleCell(cell.dataset.cellId);
      }
    }

    function toggleCell(cellId) {
      if (!cellId) return;
      if (isAdding) {
        myAvailability.add(cellId);
      } else {
        myAvailability.delete(cellId);
      }
      updateGridDisplay();
    }

    document.addEventListener('mouseup', () => {
      isMouseDown = false;
    });

    document.addEventListener('touchend', () => {
      isMouseDown = false;
    });

    function updateGridDisplay() {
      const cells = document.querySelectorAll('.grid-cell[data-cell-id]');
      const tooltip = document.getElementById('tooltip');

      if (mode === 'edit') {
        cells.forEach(cell => {
          const cellId = cell.dataset.cellId;
          cell.className = 'grid-cell' + (myAvailability.has(cellId) ? ' available' : '');
        });
      } else {
        // View mode - show aggregate
        const participantCount = Object.keys(allParticipants).length;
        cells.forEach(cell => {
          const cellId = cell.dataset.cellId;
          let count = 0;
          Object.values(allParticipants).forEach(slots => {
            if (slots.has(cellId)) count++;
          });

          cell.className = 'grid-cell';
          if (count > 0 && participantCount > 0) {
            const level = Math.ceil((count / participantCount) * 9);
            cell.classList.add(`available-${level}`);
          }

          // Add hover for tooltip
          cell.onmouseenter = (e) => {
            if (mode !== 'view') return;
            const names = [];
            Object.entries(allParticipants).forEach(([name, slots]) => {
              if (slots.has(cellId)) names.push(name);
            });
            if (names.length > 0) {
              tooltip.textContent = names.join(', ');
              tooltip.classList.add('visible');
              const rect = cell.getBoundingClientRect();
              const containerRect = cell.closest('.grid-container').getBoundingClientRect();
              tooltip.style.left = Math.max(0, rect.left - containerRect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
              tooltip.style.top = (rect.top - containerRect.top - tooltip.offsetHeight - 8) + 'px';
            }
          };
          cell.onmouseleave = () => {
            tooltip.classList.remove('visible');
          };
        });
      }
    }

    function setMode(newMode) {
      mode = newMode;
      document.querySelectorAll('.mode-toggle button').forEach((btn, i) => {
        btn.classList.toggle('active', (i === 0 && mode === 'edit') || (i === 1 && mode === 'view'));
      });
      updateGridDisplay();
    }

    function saveAvailability() {
      const name = document.getElementById('userName').value.trim();
      if (!name) {
        document.getElementById('userName').focus();
        return;
      }

      allParticipants[name] = new Set(myAvailability);
      updateParticipantList();
      updateURL();
    }

    function clearMyAvailability() {
      myAvailability.clear();
      updateGridDisplay();
    }

    function updateParticipantList() {
      const list = document.getElementById('participantList');
      const names = Object.keys(allParticipants);

      if (names.length === 0) {
        list.innerHTML = '<p style="font-size: 0.8125rem; color: #86868b;">No one yet</p>';
        return;
      }

      list.innerHTML = '';
      names.forEach(name => {
        const div = document.createElement('div');
        div.className = 'participant';
        div.innerHTML = `<span class="participant-dot"></span>${name}`;
        list.appendChild(div);
      });
    }

    function updateURL() {
      const data = {};
      Object.entries(allParticipants).forEach(([name, slots]) => {
        data[name] = Array.from(slots);
      });
      const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
      history.replaceState(null, '', '?d=' + encoded);
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('d');
      if (encoded) {
        try {
          const data = JSON.parse(decodeURIComponent(atob(encoded)));
          Object.entries(data).forEach(([name, slots]) => {
            allParticipants[name] = new Set(slots);
          });
        } catch (e) {
          console.error('Failed to load data from URL');
        }
      }
    }

    function copyLink() {
      const btn = document.getElementById('copyBtn');
      navigator.clipboard.writeText(window.location.href).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy Share Link';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    // Initialize
    generateDays();
    populateTimeSelectors();
    loadFromURL();
    renderGrid();
    updateParticipantList();
  </script>
</body>
</html>
